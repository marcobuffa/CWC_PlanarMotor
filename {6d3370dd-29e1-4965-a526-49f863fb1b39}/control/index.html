<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Planar Motor CWC</title>
        <link rel="stylesheet" href="css/style.css">
        <script src="libs/webcc.min.js"></script>
    </head>
    <body>
        <div id="MainContainer"></div>

        <script>
            var tiles = [
                {'sizeX': 100, 'sizeY': 100, 'posX': 100, 'posY': 100},
                {'sizeX': 100, 'sizeY': 100, 'posX': 400, 'posY': 400},
            ]; //array elementi spostabili
            var wincc = false; //al momento non sono in wincc (verrà verificato in seguito)
            var newTileNumber = tiles.length;

            //funzione per creare il playground
            function CreatePlayground(sizeX, sizeY){
                const divToAdd = document.createElement('div');
                divToAdd.setAttribute('id', 'PlanarContainer');
                divToAdd.setAttribute('style', 'width: ' + sizeX + 'px; height: ' + sizeY + 'px;');
                document.getElementById('MainContainer').appendChild(divToAdd);
                return divToAdd;
            }

            //funzione per la generazione di un codice RGB casuale
            function RandomColor(){
                let RGB = Math.floor(Math.random()*16777215).toString(16);
                return '0x' + RGB.padStart(6, '0');
            }

            //funzione per la creazione di un nuovo tile
            function NewTile(tile){
                //struttura immagine SVG tile
                //SVG
                // |
                // +-- rettangolo
                // +-- testo

                if (!tile.color) tile.color = RandomColor(); // se non c'è il colore, inventalo
                if (!tile.id) { //se non viene passato un id
                    tile.id = 'tile' + newTileNumber; //calcola nuovo id
                    newTileNumber++;
                }

                const divToAdd = document.getElementById('PlanarContainer'); //div a cui aggiungere la scatola
                const svgToAdd = document.createElementNS("http://www.w3.org/2000/svg", 'svg'); //intestazione SVG
                const rectToAdd = document.createElementNS("http://www.w3.org/2000/svg", 'rect'); //intestazione rettangolo
                const textToAdd = document.createElementNS("http://www.w3.org/2000/svg", 'text'); //intestazione testo
                const textToAddToText = document.createTextNode(tile.id); //testo da inserire sulla scatola
                svgToAdd.setAttribute('class', 'planar'); //aggiungi la classe "planar" alla SVG
                svgToAdd.setAttribute('width', tile.sizeX); //larghezza SVG
                rectToAdd.setAttribute('width', tile.sizeX); //larghezza rettangolo
                svgToAdd.setAttribute('height', tile.sizeY); //altezza SVG
                rectToAdd.setAttribute('height', tile.sizeY); //altezza rettangolo
                rectToAdd.setAttribute('rx', tile.sizeX/8); //raggio
                rectToAdd.setAttribute('ry', tile.sizeY/8); //raggio
                svgToAdd.setAttribute('id', tile.id); //id scatola (viene inserito nell'id della SVG)
                rectToAdd.setAttribute('style', 'fill:' + tile.color.replace('0x', '#') + '80' + '; stroke-width: 2; stroke: white'); //bordo rettangolo
                textToAdd.setAttribute('x', '50%'); //posizione orizzontale testo
                textToAdd.setAttribute('y', '50%'); //posizione verticale testo
                textToAdd.setAttribute('dominant-baseline', 'middle'); //allineamento verticale testo
                textToAdd.setAttribute('text-anchor', 'middle'); //allineamento orizzontale testo
                textToAdd.setAttribute('style', 'fill: white; font-family: sans-serif;'); //stile testo
                textToAdd.appendChild(textToAddToText); //crea testo
                svgToAdd.appendChild(rectToAdd); //aggiungi rettangolo alla SVG
                svgToAdd.appendChild(textToAdd); //aggiungi testo alla SVG
                divToAdd.appendChild(svgToAdd); //aggiungi SVG al playground
                svgToAdd.setAttribute('style', 'position: absolute; top: ' + tile.posX + 'px; left: ' + tile.posY + 'px'); //posizione iniziale SVG (altrimenti viene inserita a caso)
            };

            CreatePlayground(800, 800);
            tiles.forEach(tile => {NewTile(tile)});

            //connessione con WinCC
            WebCC.start(
                function(result) {
                    if (result) {
                        console.log("I'm in WinCC :-)");
                        wincc = true;
                    } else {
                        console.log("Let me alone: I'm not in WinCC :-(");
                    }
                },
                {
                    methods: {},
                    events: [],
                    properties: {}
                },
                ["HMI"],
                10000
            );
        </script>
    </body>
</html>